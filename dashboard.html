<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedditScout Dashboard</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --accent: #e94560;
            --accent-secondary: #0f4c75;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --positive: #4caf50;
            --negative: #f44336;
            --neutral: #9e9e9e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--accent);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header h1 span {
            color: var(--accent);
        }
        
        .header p {
            color: var(--text-secondary);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        input, select, button {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--accent-secondary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
        }
        
        button {
            background: var(--accent);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.1s;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .sentiment-bar {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .sentiment-bar .positive {
            background: var(--positive);
        }
        
        .sentiment-bar .neutral {
            background: var(--neutral);
        }
        
        .sentiment-bar .negative {
            background: var(--negative);
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
        }
        
        .posts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .post-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            transition: transform 0.2s;
        }
        
        .post-card:hover {
            transform: translateX(5px);
        }
        
        .post-card.positive {
            border-left-color: var(--positive);
        }
        
        .post-card.negative {
            border-left-color: var(--negative);
        }
        
        .post-card.neutral {
            border-left-color: var(--neutral);
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .post-subreddit {
            background: var(--accent);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .post-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .post-title a {
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .post-title a:hover {
            color: var(--accent);
        }
        
        .post-meta {
            display: flex;
            gap: 15px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            flex-wrap: wrap;
        }
        
        .post-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .tag {
            background: var(--bg-card);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .tag.category {
            background: var(--accent-secondary);
        }
        
        .sentiment-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .sentiment-badge.positive {
            background: var(--positive);
        }
        
        .sentiment-badge.negative {
            background: var(--negative);
        }
        
        .sentiment-badge.neutral {
            background: var(--neutral);
        }
        
        .category-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .category-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .category-item .count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .category-item .name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid var(--negative);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
        }
        
        .tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .competitor-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .competitor-card h3 {
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .competitor-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .file-upload {
            border: 2px dashed var(--accent-secondary);
            padding: 30px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .file-upload:hover {
            border-color: var(--accent);
        }
        
        #fileInput {
            display: none;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .stat-card .number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Reddit<span>Scout</span> üîç</h1>
        <p>Monitor Reddit for pain points, opportunities, and competitor mentions</p>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>Subreddits (comma-separated)</label>
            <input type="text" id="subreddits" placeholder="SaaS,startups,indiehackers" value="SaaS,startups,indiehackers">
        </div>
        <div class="control-group">
            <label>Competitors (optional)</label>
            <input type="text" id="competitors" placeholder="slack,notion,linear">
        </div>
        <div class="control-group">
            <label>Post Limit</label>
            <select id="limit">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
            </select>
        </div>
        <div class="control-group">
            <label>&nbsp;</label>
            <button onclick="runScan()" id="scanBtn">üîç Scan Now</button>
        </div>
        <div class="control-group">
            <label>&nbsp;</label>
            <button onclick="exportCSV()" id="exportBtn" disabled>üì• Export CSV</button>
        </div>
    </div>
    
    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept=".json" onchange="loadFile(event)">
        <p>üìÅ Drop or click to load a saved JSON file</p>
    </div>
    
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="number" id="totalPosts">-</div>
            <div class="label">Total Posts</div>
        </div>
        <div class="stat-card">
            <div class="number" id="painPoints">-</div>
            <div class="label">Pain Points</div>
        </div>
        <div class="stat-card">
            <div class="number" id="opportunities">-</div>
            <div class="label">Opportunities</div>
        </div>
        <div class="stat-card">
            <div class="number" id="sentiment">-</div>
            <div class="label">Sentiment</div>
            <div class="sentiment-bar" id="sentimentBar"></div>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="switchTab('painPoints')">üéØ Pain Points</button>
        <button class="tab" onclick="switchTab('opportunities')">üíº Opportunities</button>
        <button class="tab" onclick="switchTab('competitors')">üìä Competitors</button>
        <button class="tab" onclick="switchTab('categories')">üìà Categories</button>
    </div>
    
    <div id="painPointsTab" class="tab-content active">
        <div class="section">
            <h2>Pain Points & Help Requests</h2>
            <div class="posts-list" id="painPointsList">
                <div class="loading">Waiting for scan</div>
            </div>
        </div>
    </div>
    
    <div id="opportunitiesTab" class="tab-content">
        <div class="section">
            <h2>Opportunities & Leads</h2>
            <div class="posts-list" id="opportunitiesList">
                <div class="loading">Waiting for scan</div>
            </div>
        </div>
    </div>
    
    <div id="competitorsTab" class="tab-content">
        <div class="section">
            <h2>Competitor Mentions</h2>
            <div id="competitorsList">
                <div class="loading">Add competitor names and run a scan</div>
            </div>
        </div>
    </div>
    
    <div id="categoriesTab" class="tab-content">
        <div class="section">
            <h2>Pain Point Categories</h2>
            <div class="category-chart" id="categoryChart">
                <div class="loading">Waiting for scan</div>
            </div>
        </div>
    </div>
    
    <script>
        let currentData = null;
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        async function runScan() {
            const subreddits = document.getElementById('subreddits').value;
            const competitors = document.getElementById('competitors').value;
            const limit = document.getElementById('limit').value;
            const btn = document.getElementById('scanBtn');
            
            if (!subreddits) {
                alert('Please enter at least one subreddit');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Scanning...';
            
            document.getElementById('painPointsList').innerHTML = '<div class="loading">Scanning subreddits</div>';
            document.getElementById('opportunitiesList').innerHTML = '<div class="loading">Scanning subreddits</div>';
            
            try {
                // Use the Reddit API directly (same as scout.js)
                const subs = subreddits.split(',').map(s => s.trim());
                const allPosts = [];
                const allPainPoints = [];
                const allOpportunities = [];
                
                for (const sub of subs) {
                    try {
                        const res = await fetch(`https://www.reddit.com/r/${sub}/new/.json?limit=${limit}`, {
                            headers: { 'User-Agent': 'RedditScout/1.0' }
                        });
                        
                        if (!res.ok) continue;
                        
                        const data = await res.json();
                        const posts = extractPosts(data, sub);
                        allPosts.push(...posts);
                        
                        const painPoints = detectPainPoints(posts);
                        allPainPoints.push(...painPoints);
                        
                        const opportunities = detectOpportunities(posts);
                        allOpportunities.push(...opportunities);
                        
                        // Rate limit
                        await new Promise(r => setTimeout(r, 500));
                    } catch (e) {
                        console.error(`Error scanning r/${sub}:`, e);
                    }
                }
                
                // Track competitors if specified
                let competitorData = null;
                if (competitors) {
                    competitorData = trackCompetitors(allPosts, competitors.split(',').map(c => c.trim().toLowerCase()));
                }
                
                currentData = {
                    scannedAt: new Date().toISOString(),
                    subreddits: subs,
                    posts: allPosts,
                    painPoints: allPainPoints.sort((a, b) => b.score - a.score),
                    opportunities: allOpportunities.sort((a, b) => b.score - a.score),
                    competitors: competitorData
                };
                
                renderData(currentData);
                document.getElementById('exportBtn').disabled = false;
                
            } catch (error) {
                console.error('Scan error:', error);
                document.getElementById('painPointsList').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Scan Now';
        }
        
        // Pain signals matching scout.js
        const PAIN_SIGNALS = {
            helpSeeking: ['looking for', 'need help', 'anyone know', 'can someone', 'how do i', 'how can i', 'is there a', 'does anyone', 'please help', 'stuck on', 'cant figure out', "can't figure out", 'any advice', 'suggestions for', 'tips for', 'help me'],
            frustration: ['frustrated', 'hate when', 'wish there was', 'struggling with', 'annoyed by', 'sick of', 'tired of', 'fed up with', 'drives me crazy', 'pain point', 'nightmare', 'worst part'],
            alternatives: ['recommend', 'alternative to', 'better than', 'instead of', 'switching from', 'moved away from', 'replacement for', 'similar to', 'like X but', 'comparable to', 'competitor to'],
            pricing: ['too expensive', 'overpriced', 'price increase', 'pricing is', 'cost too much', 'cheaper alternative', 'free alternative', 'not worth the price', 'budget friendly', 'affordable option', 'subscription fatigue', 'price hike', 'raised prices'],
            featureRequests: ['wish it had', 'feature request', 'would be nice if', 'missing feature', 'needs to add', 'should have', 'hope they add', 'why cant', "why can't", 'feature suggestion', 'roadmap', 'planned feature', 'coming soon'],
            comparison: ['vs', 'versus', 'compared to', 'comparison', 'which is better', 'should i use', 'should i choose', 'or should i', 'deciding between', 'pros and cons', 'which one', 'differences between'],
            hiring: ['hiring', 'for hire', 'job', 'looking to hire', 'need a developer', 'need a designer', 'looking for freelancer', 'contract work', 'remote position', 'open position']
        };
        
        const OPPORTUNITY_SIGNALS = ['hiring', 'looking to hire', 'need a developer', 'need a designer', 'looking for freelancer', 'paid gig', 'contract work', 'remote position', 'will pay', 'budget is', 'paying', 'compensated', 'looking for a tool', 'need a solution', 'open to suggestions'];
        
        const POSITIVE_WORDS = ['love', 'amazing', 'great', 'awesome', 'excellent', 'fantastic', 'perfect', 'best', 'wonderful', 'incredible', 'brilliant', 'outstanding', 'happy', 'satisfied', 'impressed', 'recommend', 'thank', 'thanks', 'helpful', 'useful', 'solved', 'works great', 'game changer', 'life saver'];
        
        const NEGATIVE_WORDS = ['hate', 'terrible', 'awful', 'horrible', 'worst', 'bad', 'poor', 'disappointed', 'frustrat', 'annoyed', 'angry', 'useless', 'broken', 'bug', 'issue', 'problem', 'fail', 'crash', 'slow', 'expensive', 'scam', 'waste', 'regret', 'avoid', 'sucks', 'ridiculous'];
        
        function extractPosts(data, subreddit) {
            if (!data?.data?.children) return [];
            
            return data.data.children
                .filter(c => c.kind === 't3')
                .map(c => ({
                    id: c.data.id,
                    title: c.data.title,
                    selftext: c.data.selftext?.slice(0, 500) || '',
                    score: c.data.score,
                    numComments: c.data.num_comments,
                    author: c.data.author,
                    created: new Date(c.data.created_utc * 1000).toISOString(),
                    url: `https://reddit.com${c.data.permalink}`,
                    subreddit
                }));
        }
        
        function analyzeSentiment(text) {
            const lowerText = text.toLowerCase();
            let positiveScore = 0;
            let negativeScore = 0;
            
            for (const word of POSITIVE_WORDS) {
                if (lowerText.includes(word)) positiveScore++;
            }
            
            for (const word of NEGATIVE_WORDS) {
                if (lowerText.includes(word)) negativeScore++;
            }
            
            const total = positiveScore + negativeScore;
            let compound = 0;
            if (total > 0) {
                compound = (positiveScore - negativeScore) / total;
            }
            
            let label;
            if (compound >= 0.2) label = 'positive';
            else if (compound <= -0.2) label = 'negative';
            else label = 'neutral';
            
            return { label, compound };
        }
        
        function detectPainPoints(posts) {
            const allSignals = Object.values(PAIN_SIGNALS).flat();
            
            return posts.filter(p => {
                const text = `${p.title} ${p.selftext}`.toLowerCase();
                return allSignals.some(signal => text.includes(signal));
            }).map(p => {
                const text = `${p.title} ${p.selftext}`;
                const lowerText = text.toLowerCase();
                
                const categories = {};
                for (const [category, signals] of Object.entries(PAIN_SIGNALS)) {
                    const matched = signals.filter(s => lowerText.includes(s));
                    if (matched.length > 0) {
                        categories[category] = matched;
                    }
                }
                
                return {
                    ...p,
                    signals: allSignals.filter(s => lowerText.includes(s)),
                    categories,
                    sentiment: analyzeSentiment(text)
                };
            });
        }
        
        function detectOpportunities(posts) {
            return posts.filter(p => {
                const text = `${p.title} ${p.selftext}`.toLowerCase();
                return OPPORTUNITY_SIGNALS.some(signal => text.includes(signal));
            }).map(p => ({
                ...p,
                signals: OPPORTUNITY_SIGNALS.filter(s => `${p.title} ${p.selftext}`.toLowerCase().includes(s)),
                sentiment: analyzeSentiment(`${p.title} ${p.selftext}`)
            }));
        }
        
        function trackCompetitors(posts, competitors) {
            const mentions = [];
            
            for (const post of posts) {
                const text = `${post.title} ${post.selftext}`.toLowerCase();
                const matched = competitors.filter(c => text.includes(c));
                
                if (matched.length > 0) {
                    mentions.push({
                        ...post,
                        competitors: matched,
                        sentiment: analyzeSentiment(`${post.title} ${post.selftext}`)
                    });
                }
            }
            
            const byCompetitor = {};
            for (const comp of competitors) {
                byCompetitor[comp] = mentions.filter(m => m.competitors.includes(comp));
            }
            
            const sentimentByCompetitor = {};
            for (const [comp, posts] of Object.entries(byCompetitor)) {
                sentimentByCompetitor[comp] = {
                    total: posts.length,
                    positive: posts.filter(p => p.sentiment?.label === 'positive').length,
                    negative: posts.filter(p => p.sentiment?.label === 'negative').length,
                    neutral: posts.filter(p => p.sentiment?.label === 'neutral').length
                };
            }
            
            return { mentions, byCompetitor, sentimentByCompetitor };
        }
        
        function renderData(data) {
            // Update stats
            document.getElementById('totalPosts').textContent = data.posts.length;
            document.getElementById('painPoints').textContent = data.painPoints.length;
            document.getElementById('opportunities').textContent = data.opportunities.length;
            
            // Calculate overall sentiment
            const sentiments = data.painPoints.map(p => p.sentiment?.label);
            const pos = sentiments.filter(s => s === 'positive').length;
            const neg = sentiments.filter(s => s === 'negative').length;
            const neu = sentiments.filter(s => s === 'neutral').length;
            const total = pos + neg + neu || 1;
            
            const avgSentiment = ((pos - neg) / total).toFixed(2);
            document.getElementById('sentiment').textContent = avgSentiment >= 0 ? `+${avgSentiment}` : avgSentiment;
            
            document.getElementById('sentimentBar').innerHTML = `
                <div class="positive" style="width: ${(pos/total)*100}%"></div>
                <div class="neutral" style="width: ${(neu/total)*100}%"></div>
                <div class="negative" style="width: ${(neg/total)*100}%"></div>
            `;
            
            // Render pain points
            renderPosts(data.painPoints, 'painPointsList');
            
            // Render opportunities
            renderPosts(data.opportunities, 'opportunitiesList');
            
            // Render categories
            renderCategories(data.painPoints);
            
            // Render competitors
            if (data.competitors) {
                renderCompetitors(data.competitors);
            }
        }
        
        function renderPosts(posts, containerId) {
            const container = document.getElementById(containerId);
            
            if (posts.length === 0) {
                container.innerHTML = '<div class="loading">No matches found</div>';
                return;
            }
            
            container.innerHTML = posts.slice(0, 50).map(post => `
                <div class="post-card ${post.sentiment?.label || 'neutral'}">
                    <div class="post-header">
                        <span class="post-subreddit">r/${post.subreddit}</span>
                        <span class="sentiment-badge ${post.sentiment?.label || 'neutral'}">${post.sentiment?.label || 'neutral'}</span>
                    </div>
                    <div class="post-title">
                        <a href="${post.url}" target="_blank">${escapeHtml(post.title)}</a>
                    </div>
                    <div class="post-meta">
                        <span>üë§ u/${post.author}</span>
                        <span>‚¨ÜÔ∏è ${post.score}</span>
                        <span>üí¨ ${post.numComments}</span>
                        <span>üìÖ ${new Date(post.created).toLocaleDateString()}</span>
                    </div>
                    ${post.categories ? `
                        <div class="post-tags">
                            ${Object.keys(post.categories).map(cat => `<span class="tag category">${cat}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function renderCategories(painPoints) {
            const categories = {};
            for (const pp of painPoints) {
                for (const cat of Object.keys(pp.categories || {})) {
                    categories[cat] = (categories[cat] || 0) + 1;
                }
            }
            
            const container = document.getElementById('categoryChart');
            
            if (Object.keys(categories).length === 0) {
                container.innerHTML = '<div class="loading">No categories detected</div>';
                return;
            }
            
            container.innerHTML = Object.entries(categories)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => `
                    <div class="category-item">
                        <div class="count">${count}</div>
                        <div class="name">${name}</div>
                    </div>
                `).join('');
        }
        
        function renderCompetitors(data) {
            const container = document.getElementById('competitorsList');
            
            if (!data || data.mentions.length === 0) {
                container.innerHTML = '<div class="loading">No competitor mentions found</div>';
                return;
            }
            
            container.innerHTML = Object.entries(data.sentimentByCompetitor)
                .filter(([_, stats]) => stats.total > 0)
                .map(([comp, stats]) => `
                    <div class="competitor-card">
                        <h3>${comp}</h3>
                        <div class="competitor-stats">
                            <span>üìä ${stats.total} mentions</span>
                            <span style="color: var(--positive)">üëç ${stats.positive}</span>
                            <span style="color: var(--neutral)">üòê ${stats.neutral}</span>
                            <span style="color: var(--negative)">üëé ${stats.negative}</span>
                        </div>
                        <div class="sentiment-bar">
                            <div class="positive" style="width: ${(stats.positive/stats.total)*100}%"></div>
                            <div class="neutral" style="width: ${(stats.neutral/stats.total)*100}%"></div>
                            <div class="negative" style="width: ${(stats.negative/stats.total)*100}%"></div>
                        </div>
                    </div>
                `).join('') + 
                `<h3 style="margin-top: 20px;">Recent Mentions</h3>` +
                `<div class="posts-list">${data.mentions.slice(0, 10).map(post => `
                    <div class="post-card ${post.sentiment?.label || 'neutral'}">
                        <div class="post-header">
                            <span class="post-subreddit">r/${post.subreddit}</span>
                            <span class="sentiment-badge ${post.sentiment?.label || 'neutral'}">${post.sentiment?.label || 'neutral'}</span>
                        </div>
                        <div class="post-title">
                            <a href="${post.url}" target="_blank">${escapeHtml(post.title)}</a>
                        </div>
                        <div class="post-tags">
                            ${post.competitors.map(c => `<span class="tag">${c}</span>`).join('')}
                        </div>
                    </div>
                `).join('')}</div>`;
        }
        
        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    currentData = JSON.parse(e.target.result);
                    
                    // Handle different data formats
                    if (!currentData.posts && currentData.results) {
                        // Multi-scan format
                        currentData.posts = currentData.results.flatMap(r => r.posts || []);
                    }
                    if (!currentData.painPoints && currentData.aggregated?.painPoints) {
                        currentData.painPoints = currentData.aggregated.painPoints;
                    }
                    if (!currentData.opportunities && currentData.aggregated?.opportunities) {
                        currentData.opportunities = currentData.aggregated.opportunities;
                    }
                    
                    currentData.painPoints = currentData.painPoints || [];
                    currentData.opportunities = currentData.opportunities || [];
                    currentData.posts = currentData.posts || [];
                    
                    renderData(currentData);
                    document.getElementById('exportBtn').disabled = false;
                    
                } catch (err) {
                    alert('Error parsing JSON file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function exportCSV() {
            if (!currentData || !currentData.painPoints) {
                alert('No data to export');
                return;
            }
            
            const fields = ['id', 'subreddit', 'title', 'author', 'score', 'numComments', 'created', 'url', 'sentiment', 'categories'];
            const rows = [fields.join(',')];
            
            for (const post of currentData.painPoints) {
                const row = fields.map(f => {
                    let val = post[f];
                    if (f === 'sentiment') val = post.sentiment?.label || '';
                    if (f === 'categories') val = Object.keys(post.categories || {}).join('; ');
                    if (val === null || val === undefined) val = '';
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = `"${val}"`;
                    }
                    return val;
                });
                rows.push(row.join(','));
            }
            
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reddit-scout-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
